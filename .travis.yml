# ==============================
# COMMON SETUP
# ==============================
# Travis only runs on:
# Commit to "continuous" branch.
# Valid semver tag is created.
# ==============================
language: node_js

node_js:
  - '8'

env:
  global:
    # Versions
    - NPM_VERSION="6.0.1"
    - YARN_VERSION="1.6.0"
    # Directories
    - RB_SHOWCASE_DIR="$TRAVIS_BUILD_DIR"
    - RB_COMPONENTS_DIR="$RB_SHOWCASE_DIR/.."
    - YARN_LINK_DIR="$(yarn global dir)/../link"
    # TOKENS (in order): HEROKU_API_KEY
    - secure: f/m6AZl0/n+bGmPSmWL4zn7dcr3HINMsBdzh7jvdSs/rqcY24bgDxeMJmz21tIOiCn5SMSM908+C2sUJ9wIk3GG12ejIIyxX5nRtBo54wSRl2cBoEW4ARAYzGr8QzXWc63ykX9kovRbtNCLI8BDMENuwJHeQg9CcEoUfJmv+fe21KY5Q/zLFOcEbZJIwn84yoApBQnq5ukd0n/GjBSrv2zwHunhGV09y9PHV4rGRMfeQ5tpXz40qLCFEYXohqejIWE/PudrUck4St6jLvZLpnOuWGDNQu0G5Uy/2HnS48HT0ljZZy+KxGhFj8y+1lHtTEuFaY6i37AUD0NT/alKUs4Y/56IrSD/k4h6jpsyuSLIiOGk0q2gY6WhBJvDIv4PNTQOzjK+o/uG44c1J0d+wV+mj9A5g+1tvn0tP68s5sLA4TIVGmnPTFEgToZX1WHGVp12ViLvOmpFsdtsh/KKLcTyOzBO+KYbMd4hcNq+mTPyM+GlKm4mX5waHwD19httu96KXqfcf5+U8Ttrnq+jW+w/6+AmFQwkxZ1Cta+y5g2KmBJju7gU1aXSYTvyrBhvcQe4x2E2755leYHz5AnUzVt8QS3LuUTT6Pf2/Qz+gkqeUExTjK0NEWtn22FfKmr30Gy+Tz5kigIBYfW4Ub1pfj05umX5XpAHAJo3Cpk5HmvA=

cache:
  directories:
    - node_modules     # repo root node_modules
    - "$(npm root -g)" # global node_modules directory
    - "$(npm bin -g)/rapid-build"
    - "$(npm bin -g)/yarn"
    - "$(npm bin -g)/yarnpkg"

# Install Global Dependencies
# ===========================
before_install:
  - if [[ $(npm -v) != $NPM_VERSION ]]; then npm install -g npm@${NPM_VERSION}; fi     # version check
  - if [[ $(yarn -v) != $YARN_VERSION ]]; then npm install -g yarn@${YARN_VERSION}; fi # version check
  - if [[ -z $(command -v rapid-build) ]]; then npm install -g rapid-build@5; fi       # if not installed

# Shared Heroku Settings
# ======================
deploy: &heroku
  provider: heroku
  skip_cleanup: true
  api_key: $HEROKU_API_KEY

# ===================================
# SPECIFIC JOBS
# ===================================
# - before_script:
#   Runs after npm install.
#   Stops build immediately on error.
# - Release Job:
#   Must be a valid semver tag.
#   Examples: v1.0.0 or v1.0.0-beta.1
# ===================================
jobs:
  include:
    # Continuous
    # ==========
    - if: branch = continuous
      before_script:
        # STEPS (in order)
        # ================
        # Clone Component Repos
        # Setup Components
        # Setup Showcase
        # Build Showcase
        - node scripts/travis/continuous $RB_SHOWCASE_DIR $RB_COMPONENTS_DIR
      deploy:
        <<: *heroku
        app: rapid-build-ui-io-dev
        on:
          branch: continuous

    # Release
    # =======
    - if: tag =~ ^v(\d+\.)(\d+\.)(\d+)(-([A-Za-z]+\.)?(\d+\.)?(\d+\.)?(\d+))?$
      before_script:
        # STEPS (in order)
        # ================
        # Install Client
        # Install Server
        # Build Showcase
        - node scripts/travis/release $RB_SHOWCASE_DIR
      deploy:
        <<: *heroku
        app: rapid-build-ui-io-staging
        on:
          tags: true
